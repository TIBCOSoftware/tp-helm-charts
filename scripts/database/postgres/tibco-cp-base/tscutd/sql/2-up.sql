-- Database schema changes for 1.0.1

-- Update database schema at the end (earlier version is 1.0.0 i.e. 1)
UPDATE schema_version SET version = 2;

DROP MATERIALIZED VIEW IF EXISTS V3_VIEW_DATA_PLANE_MONITOR_DETAILS CASCADE;
CREATE MATERIALIZED VIEW V3_VIEW_DATA_PLANE_MONITOR_DETAILS
AS
SELECT
    VDP.SUBSCRIPTION_ID,
    json_agg(row_to_json((
    SELECT ColumnName
    FROM (SELECT VDP.DP_ID, VDP.REGISTERED_REGION, VDP.RUNNING_REGION, VDP.DP_CONFIG, VDP.STATUS, VDP.HOST_CLOUD_TYPE, DPCP.CAPABILITIES)
        AS ColumnName (DP_ID, REGISTERED_REGION, RUNNING_REGION, DP_CONFIG, DP_STATUS, HOST_CLOUD_TYPE, CAPABILITIES)
    ))) DATAPLANES
FROM V3_DATA_PLANES VDP LEFT JOIN (SELECT DP_ID, json_agg(row_to_json((
    SELECT ColumnName
    FROM (
        SELECT CAPABILITY_INSTANCE_ID, CAPABILITY_INSTANCE_NAME, CAPABILITY_INSTANCE_DESCRIPTION, CAPABILITY_ID, DISPLAY_NAME, CI.CAPABILITY_TYPE, NAMESPACE, CI.VERSION, STATUS, REGION, TAGS)
            AS ColumnName (CAPABILITY_INSTANCE_ID, CAPABILITY_INSTANCE_NAME, CAPABILITY_INSTANCE_DESCRIPTION, CAPABILITY_ID, NAME, CAPABILITY_TYPE, NAMESPACE, VERSION, STATUS, REGION, TAGS)
        ))) CAPABILITIES
        FROM (V3_CAPABILITY_INSTANCES CI LEFT JOIN V3_CAPABILITY_METADATA CR USING (CAPABILITY_ID,CAPABILITY_TYPE))
        GROUP BY DP_ID) DPCP USING(DP_ID)
GROUP BY VDP.SUBSCRIPTION_ID
    WITH DATA;

CREATE UNIQUE INDEX V3_VIEW_DATA_PLANE_MONITOR_DETAILS_INDEX ON V3_VIEW_DATA_PLANE_MONITOR_DETAILS (SUBSCRIPTION_ID);

-- Update BWCE Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"recipe":{"helmCharts":[{"name":"bwprovisioner","namespace":"${NAMESPACE}","version":"1.0.31","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"values":[{"content":"global:\n  bwprovisioner:\n    image:\n      tag: 287\nconfig:\n  APP_INIT_IMAGE_TAG: \"20\"\npublicApi:\n  ingress:\n    controllerName: ${INGRESS_CONTROLLER_NAME}\n    nginx:\n      className: ${INGRESS_CLASS_NAME}\n      pathPrefix: ${INGRESS_PATH_PREFIX}\n      fqdn: ${INGRESS_FQDN}\n"}],"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}}]},"services":[{"name":"bwprovisioner","description":"BW Provisioner Service"},{"name":"oauth2-proxy","description":"OAuth2 Proxy"}],"dependsOn":[{"version":[1,0,0],"capabilityId":"INTEGRATIONCORE","capabilityType":"INFRA"},{"version":[1,0,0],"capabilityId":"OAUTH2PROXY","capabilityType":"INFRA_SIDECAR"}],"provisioningRoles":["DEV_OPS"],"allowMultipleInstances":false,"capabilityResourceDependencies":[{"required":true,"resourceId":"INGRESS","resourceType":"PLATFORM","type":"Ingress Controller"}]}}'
WHERE CAPABILITY_ID = 'BWCE' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'PLATFORM';

-- Update INTEGRATIONCORE Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"recipe":{"helmCharts":[{"name":"artifactmanager","namespace":"${NAMESPACE}","version":"1.0.25","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"values":[{"content":"global:\n  artifactmanager:\n    image:\n      tag: 46\nvolumes:\n  artifactmanager:\n    persistentVolumeClaim:\n      resources:\n        requests:\n          storage: 20Gi\n"}],"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}},{"name":"distributed-lock-operator","namespace":"${NAMESPACE}","version":"1.0.77","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"values":[{"content":"global:\n  distlockop:\n    image:\n      tag: 72\n"}],"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}}]},"services":[{"name":"artifactmanager","description":"Artifact Manager"},{"name":"distributed-lock-operator","description":"Distributed Lock Operator"}],"dependsOn":[],"provisioningRoles":["DEV_OPS"],"allowMultipleInstances":false,"capabilityResourceDependencies":[{"resourceType":"INFRA","required":true,"resourceId":"STORAGE","type":"Storage Class"}]}}'
WHERE CAPABILITY_ID = 'INTEGRATIONCORE' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'INFRA';

-- Update SECRETCONTROLLER recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"recipe":{"helmCharts":[{"name":"tp-dp-secret-controller","namespace":"${NAMESPACE}","version":"1.0.43","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}}]},"services":[{"name":"dp-secret-controller","description":"Secret Controller"}],"dependsOn":[],"provisioningRoles":["DEV_OPS"],"allowMultipleInstances":false,"capabilityResourceDependencies":[]}}'
WHERE CAPABILITY_ID = 'SECRETCONTROLLER' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE='INFRA';

-- Update TIBCOHUB capability package
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"allowMultipleInstances":false,"capabilityResourceDependencies":[{"required":true,"resourceId":"INGRESS","resourceType":"PLATFORM","type":"Ingress Controller"},{"required":true,"resourceId":"STORAGE","resourceType":"PLATFORM","type":"Storage Class"}],"dependsOn":[{"capabilityId":"OAUTH2PROXY","version":[1,0,0],"capabilityType":"INFRA_SIDECAR"}],"provisioningRoles":["DEV_OPS"],"recipe":{"helmCharts":[{"name":"tibco-developer-hub","version":"1.0.32","namespace":"${NAMESPACE}","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"values":[{"content":"baseUrlKeyPath: backstage.appConfig.app.baseUrl\nbackstage:\n  appConfig:\n    app:\n      baseUrl: ${PUBLIC_URL}\n    backend:\n      baseUrl: ${PUBLIC_URL}\n    auth:\n      providers:\n        oauth2Proxy:\n          development: {}\n      enableAuthProviders: [oauth2Proxy]    \n  # only if user provides a secrets reference \n  # extraEnvVarsSecrets:\n  #  - ${SECRETS_NAME}\npostgresql:\n  enabled: true\ningress:\n  enabled: true\n  className: ${INGRESS_CLASSNAME}\n  host: ${HOSTNAME}\n"}],"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}}]},"services":[{"description":"Postgres Database","name":"postgresql"},{"description":"NodeJs backend and UI hosting service","name":"tibco-developer-hub"},{"name":"oauth2-proxy","description":"OAuth2 Proxy"}]}}',
DISPLAY_NAME = 'TIBCO® Developer Hub', DESCRIPTION = 'TIBCO® Developer Hub is a one-stop shop for developers on TIBCO Platform, where you can find and share documentation and assets with other developers. You can also create new TIBCO assets based on templates.'
WHERE CAPABILITY_ID = 'TIBCOHUB' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'PLATFORM';

-- Update O11Y INFRA Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package": {"recipe": {"helmCharts": [{"name": "o11yservice", "flags": {"install": true, "createNamespace": false, "dependencyUpdate": true}, "version": "1.0.55", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-userapp\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\nautoscaling:\n  enabled: false\n  minReplicas: 1\n  maxReplicas: 10\n  behavior:\n    scaleUp:\n      stabilizationWindowSeconds: 15\n    scaleDown:\n      stabilizationWindowSeconds: 15\n  targetCPUUtilizationPercentage: 80\n  targetMemoryUtilizationPercentage: 80\nserviceAccount:\n  create: false\n  name: ${SERVICE-ACCOUNT}\nports:\n  otlp:\n    enabled: true\n    containerPort: 4317\n    servicePort: 4317\n    hostPort: 4317\n    protocol: TCP\n    # nodePort: 30317\n    appProtocol: grpc\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: false\n    containerPort: 8888\n    servicePort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    otlp:\n      protocols:\n        grpc:\n          endpoint: 0.0.0.0:4317\n        http:\n          cors:\n            allowed_origins:\n              - http://*\n              - https://*\n          endpoint: 0.0.0.0:4318\n  processors:\n    memory_limiter: null\n    batch: {}\n    filter/devnull:\n      error_mode: ignore\n      traces:\n        span:\n          - ''name != \"\"''\n      metrics:\n        metric:\n          - ''name != \"\"''\n        datapoint:\n          - ''metric.name != \"\"''\n      logs:\n        log_record:\n          - ''IsMatch(body, \"\")''\n    memory_limiter:\n      check_interval: 5s\n      limit_percentage: 80\n      spike_limit_percentage: 25\n  exporters:\n    logging: {}\n  extensions:\n    health_check: {}\n    memory_ballast:\n      size_in_percentage: 40\n  service:\n    telemetry:\n      logs: {}\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      logs:\n        exporters:\n          - logging\n        processors:\n          - filter/devnull\n        receivers:\n          - otlp\n      metrics:\n        exporters:\n          - logging\n        processors:\n          - filter/devnull\n        receivers:\n          - otlp\n      traces:\n        exporters:\n          - logging\n        processors:\n          - filter/devnull\n        receivers:\n          - otlp\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-userapp"}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-finops\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\nserviceAccount:\n  create: false\n  name: ${SERVICE-ACCOUNT}\nports:\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: false\n    containerPort: 8888\n    servicePort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    prometheus/finops:\n      config:\n        scrape_configs:\n          - job_name: monitoring-agent\n            scrape_interval: 60s\n            kubernetes_sd_configs:\n            - role: service\n            relabel_configs:\n            - action: keep\n              source_labels: [__meta_kubernetes_service_label_platform_tibco_com_scrape_finops]\n              regex: \"true\"\n            - action: keep\n              regex: \"true\"\n              source_labels:\n              - __meta_kubernetes_service_label_prometheus_io_scrape\n            - action: keep\n              regex: ${DATAPLANE-ID}\n              source_labels:\n              - __meta_kubernetes_service_label_platform_tibco_com_dataplane_id\n            - action: replace\n              regex: (.+)\n              source_labels:\n              - __meta_kubernetes_service_annotation_prometheus_io_path\n              target_label: __metrics_path__\n  processors:\n    memory_limiter:\n      check_interval: 1s\n      limit_mib: 2000\n    batch: {}\n    attributes/finops:\n      actions:\n      - key: dataplane_id\n        action: insert\n        value: ${DATAPLANE-ID}\n  exporters:\n    logging: {}\n    otlphttp/finops:\n      metrics_endpoint: http://cp-proxy/finops/finops-service/api/v1/proxy\n  service:\n    telemetry:\n      logs: {}\n      metrics:\n        address: :8888\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      metrics:\n        exporters:\n          - logging\n          - otlphttp/finops\n        processors:\n          - memory_limiter\n          - batch\n          - attributes/finops\n        receivers:\n          - prometheus/finops\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-finops"}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-services\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\nserviceAccount:\n  create: false\n  annotations: {}\n  name: ${SERVICE-ACCOUNT}\nports:\n  otlp:\n    enabled: true\n    containerPort: 4317\n    servicePort: 4317\n    hostPort: 4317\n    protocol: TCP\n    # nodePort: 30317\n    appProtocol: grpc\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: false\n    containerPort: 8888\n    servicePort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    otlp:\n      protocols:\n        grpc:\n          endpoint: 0.0.0.0:4317\n        http:\n          cors:\n            allowed_origins:\n              - http://*\n              - https://*\n          endpoint: 0.0.0.0:4318\n  processors:\n    memory_limiter:\n      check_interval: 1s\n      limit_mib: 2000\n    batch: {}\n  exporters:\n    logging: {}\n  service:\n    telemetry:\n      logs: {}\n      metrics:\n        address: :8888\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      logs:\n        exporters:\n          - logging\n        processors:\n          - memory_limiter\n          - batch\n        receivers:\n          - otlp\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-services"}, {"name": "jaeger", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "provisionDataStore:\n  cassandra: false\n  elasticsearch: false\nstorage:\n  type: memory\nagent:\n  enabled: false\nquery:\n  fullnameOverride: jaeger-query\n  podLabels:\n    networking.platform.tibco.com/kubernetes-api: enable\n    egress.networking.platform.tibco.com/internet-all: enable\n  serviceAccount:\n    create: false\n    name: ${SERVICE-ACCOUNT}\n  ingress:\n    enabled: true\n    ingressClassName: haproxy-dp-${DATAPLANE-ID}\n    annotations:\n      haproxy.org/cors-enable: \"true\"\n      haproxy.org/load-balance: leastconn\n      haproxy.org/src-ip-header: X-Real-IP\n      haproxy.org/timeout-http-request: 600s\n      ingress.kubernetes.io/rewrite-target: /\n      meta.helm.sh/release-name: jaeger\n    pathType: Prefix\n    hosts:\n      -\n  oAuthSidecar:\n    enabled: false\n  agentSidecar:\n    enabled: false\ncollector:\n  fullnameOverride: jaeger-collector\n  podLabels:\n    networking.platform.tibco.com/kubernetes-api: enable\n    egress.networking.platform.tibco.com/internet-all: enable\n  serviceAccount:\n    create: false\n    name: ${SERVICE-ACCOUNT}\n  autoscaling:\n    enabled: false\n    minReplicas: 2\n    maxReplicas: 10\n    behavior:\n      targetCPUUtilizationPercentage: 80\n      targetMemoryUtilizationPercentage: 80\n  service:\n    otlp:\n      grpc:\n        name: otlp-grpc\n        port: 4317\n      http:\n        name: otlp-http\n        port: 4318\n"}], "version": "0.71.24", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "jaeger"}], "deploymentStrategy": "weighted-concurrency"}, "services": [{"name": "o11y-service", "description": "o11y Service"}, {"name": "jaeger-collector", "description": "jaeger collector"}, {"name": "jaeger-query", "description": "jaeger query"}, {"name": "otel-userapp", "description": "otel userapp"}, {"name": "otel-finops", "description": "otel finops"}, {"name": "otel-services", "description": "otel services"}], "dependsOn": [], "provisioningRoles": ["DEV_OPS"], "allowMultipleInstances": false}}'
WHERE CAPABILITY_ID = 'O11Y' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'INFRA';

-- Update O11Y PLATFORM Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package": {"recipe": {"helmCharts": [{"name": "o11yservice", "flags": {"install": true, "createNamespace": false, "dependencyUpdate": true}, "version": "1.0.55", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-userapp\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\n  prometheus.io/scrape: \"true\"\n  prometheus.io/path: \"metrics\"\n  prometheus.io/port: \"4319\"\nautoscaling:\n  enabled: false\n  minReplicas: 1\n  maxReplicas: 10\n  behavior:\n    scaleUp:\n      stabilizationWindowSeconds: 15\n    scaleDown:\n      stabilizationWindowSeconds: 15\n  targetCPUUtilizationPercentage: 80\n  targetMemoryUtilizationPercentage: 80\nserviceAccount:\n  create: false\n  name: ${SERVICE-ACCOUNT}\nextraEnvs:\n  - name: KUBE_NODE_NAME\n    valueFrom:\n      fieldRef:\n        apiVersion: v1\n        fieldPath: spec.nodeName\nextraEnvsFrom:\n  - secretRef:\n      name: o11y-service\n  - configMapRef:\n      name: o11y-service\nports:\n  otlp:\n    enabled: true\n    containerPort: 4317\n    servicePort: 4317\n    hostPort: 4317\n    protocol: TCP\n    # nodePort: 30317\n    appProtocol: grpc\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: true\n    containerPort: 8888\n    servicePort: 8888\n    hostPort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    otlp:\n      protocols:\n        grpc:\n          endpoint: 0.0.0.0:4317\n        http:\n          cors:\n            allowed_origins:\n              - http://*\n              - https://*\n          endpoint: 0.0.0.0:4318\n    prometheus:\n      config:\n        scrape_configs:\n         - job_name: monitoring-agent\n           scrape_interval: 20s\n           kubernetes_sd_configs:\n           - role: service\n           relabel_configs:\n           - action: keep\n             source_labels: [__meta_kubernetes_service_label_prometheus_io_scrape]\n             regex: \"true\"\n           - action: keep\n             source_labels: [__meta_kubernetes_service_label_platform_tibco_com_dataplane_id]\n             regex: \"${DATAPLANE-ID}\"\n           - action: replace\n             source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n             target_label: __metrics_path__\n             regex: (.+)\n         - job_name: envoy-stats\n           scrape_interval: 20s\n           kubernetes_sd_configs:\n           - role: pod\n           relabel_configs:\n           - action: keep\n             source_labels: [__meta_kubernetes_pod_label_prometheus_io_scrape]\n             regex: \"true\"\n           - action: keep\n             source_labels: [__meta_kubernetes_pod_container_port_name]\n             regex: \".*-envoy-prom\"\n           - action: keep\n             source_labels: [__meta_kubernetes_pod_label_platform_tibco_com_dataplane_id]\n             regex: \"${DATAPLANE-ID}\"\n           - action: replace\n             source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n             target_label: __metrics_path__\n             regex: (.+)\n  processors:\n    memory_limiter:\n      check_interval: 5s\n      limit_percentage: 80\n      spike_limit_percentage: 25\n    batch: {}\n    k8sattributes/general:\n      auth_type: \"serviceAccount\"\n      passthrough: false\n      extract:\n        metadata:\n          - k8s.pod.name\n          - k8s.pod.uid\n          - k8s.namespace.name\n        annotations:\n          - tag_name: connectors\n            key: platform.tibco.com/connectors\n            from: pod\n        labels:\n          - tag_name: app_id\n            key: platform.tibco.com/app-id\n            from: pod\n          - tag_name: app_type\n            key: platform.tibco.com/app-type\n            from: pod\n          - tag_name: dataplane_id\n            key: platform.tibco.com/dataplane-id\n            from: pod\n          - tag_name: workload_type\n            key: platform.tibco.com/workload-type\n            from: pod\n          - tag_name: app_name\n            key: platform.tibco.com/app-name\n            from: pod\n          - tag_name: app_version\n            key: platform.tibco.com/app-version\n            from: pod\n          - tag_name: app_tags\n            key: platform.tibco.com/tags\n            from: pod\n          - tag_name: capability_instance_id\n            key: platform.tibco.com/capability-instance-id\n            from: pod\n    transform/logs:\n      log_statements:\n      - context: log\n        statements:\n        - set(resource.attributes[\"pod_namespace\"], resource.attributes[\"k8s.namespace.name\"])\n        - set(resource.attributes[\"pod_name\"], resource.attributes[\"k8s.pod.name\"])\n        - set(resource.attributes[\"pod_uid\"], resource.attributes[\"k8s.pod.uid\"])\n        - delete_key(resource.attributes, \"k8s.namespace.name\")\n        - delete_key(resource.attributes, \"k8s.pod.name\")\n        - delete_key(resource.attributes, \"k8s.pod.uid\")\n        - delete_key(resource.attributes, \"k8s.pod.ip\")\n    transform/traces:\n      trace_statements:\n      - context: span\n        statements:\n          - set(attributes[\"pod_name\"], resource.attributes[\"k8s.pod.name\"])\n          - set(attributes[\"pod_namespace\"], resource.attributes[\"k8s.namespace.name\"])\n          - set(attributes[\"app_id\"], resource.attributes[\"app_id\"])\n          - set(attributes[\"app_type\"], resource.attributes[\"app_type\"])\n          - set(attributes[\"dataplane_id\"], resource.attributes[\"dataplane_id\"])\n          - set(attributes[\"workload_type\"], resource.attributes[\"workload_type\"])\n          - set(attributes[\"app_tags\"], resource.attributes[\"app_tags\"])\n          - set(attributes[\"app_name\"], resource.attributes[\"app_name\"])\n          - set(attributes[\"app_version\"], resource.attributes[\"app_version\"])\n          - set(attributes[\"capability_instance_id\"], resource.attributes[\"capability_instance_id\"])\n  exporters:\n    elasticsearch/log:\n      endpoints:\n      - ${env:ES_SERVER_EXPORTER_ENDPOINT}\n      logs_index: ${env:ES_EXPORTER_LOG_INDEX_NAME}\n      user: ${env:ES_EXPORTER_LOG_INDEX_USERNAME}\n      password: ${env:ES_EXPORTER_LOG_INDEX_PASSWORD}\n      retry:\n        enabled: false\n      tls:\n        insecure: false\n        insecure_skip_verify: true\n    otlp/trace:\n      endpoint: ${env:JAEGER_COLLECTOR_ENDPOINT}\n      tls:\n        insecure: true\n    prometheus/user:\n      endpoint: 0.0.0.0:4319\n      enable_open_metrics: true\n      resource_to_telemetry_conversion:\n        enabled: true\n  extensions:\n    health_check: {}\n    memory_ballast:\n      size_in_percentage: 40\n  service:\n    telemetry:\n      logs: {}\n      metrics:\n        address: :8888\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      logs:\n        receivers:\n          - otlp\n        processors:\n          - k8sattributes/general\n          - transform/logs\n          - memory_limiter\n          - batch\n        exporters:\n          - elasticsearch/log\n      metrics/appengines:\n        receivers:\n          - otlp\n          - prometheus\n        processors:\n          - k8sattributes/general\n          - memory_limiter\n          - batch\n        exporters:\n          - prometheus/user\n      traces:\n        receivers:\n          - otlp\n        processors:\n          - k8sattributes/general\n          - transform/traces\n          - memory_limiter\n          - batch\n        exporters:\n          - otlp/trace\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-userapp"}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-finops\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\nserviceAccount:\n  create: false\n  name: ${SERVICE-ACCOUNT}\nextraEnvsFrom:\n  - configMapRef:\n      name: o11y-service\nports:\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: true\n    containerPort: 8888\n    servicePort: 8888\n    hostPort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    prometheus/finops:\n      config:\n        scrape_configs:\n          - job_name: monitoring-agent\n            scrape_interval: 60s\n            kubernetes_sd_configs:\n            - role: service\n            relabel_configs:\n            - action: keep\n              source_labels: [__meta_kubernetes_service_label_platform_tibco_com_scrape_finops]\n              regex: \"true\"\n            - action: keep\n              regex: \"true\"\n              source_labels:\n              - __meta_kubernetes_service_label_prometheus_io_scrape\n            - action: keep\n              regex: ${DATAPLANE-ID}\n              source_labels:\n              - __meta_kubernetes_service_label_platform_tibco_com_dataplane_id\n            - action: replace\n              regex: (.+)\n              source_labels:\n              - __meta_kubernetes_service_annotation_prometheus_io_path\n              target_label: __metrics_path__\n  processors:\n    memory_limiter:\n      check_interval: 1s\n      limit_mib: 2000\n    batch: {}\n    attributes/finops:\n      actions:\n      - key: dataplane_id\n        action: insert\n        value: ${DATAPLANE-ID}\n  exporters:\n    logging: {}\n    otlphttp/finops:\n      metrics_endpoint: http://cp-proxy/finops/finops-service/api/v1/proxy\n  service:\n    telemetry:\n      logs: {}\n      metrics:\n        address: :8888\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      metrics:\n        exporters:\n          - logging\n          - otlphttp/finops\n        processors:\n          - memory_limiter\n          - batch\n          - attributes/finops\n        receivers:\n          - prometheus/finops\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-finops"}, {"name": "opentelemetry-collector", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "mode: \"deployment\"\nfullnameOverride: otel-services\npodLabels:\n  networking.platform.tibco.com/kubernetes-api: enable\n  egress.networking.platform.tibco.com/internet-all: enable\nserviceAccount:\n  create: false\n  name: ${SERVICE-ACCOUNT}\nextraEnvsFrom:\n  - secretRef:\n      name: o11y-service\n  - configMapRef:\n      name: o11y-service\nports:\n  otlp:\n    enabled: true\n    containerPort: 4317\n    servicePort: 4317\n    hostPort: 4317\n    protocol: TCP\n    # nodePort: 30317\n    appProtocol: grpc\n  otlp-http:\n    enabled: true\n    containerPort: 4318\n    servicePort: 4318\n    hostPort: 4318\n    protocol: TCP\n  metrics:\n    enabled: true\n    containerPort: 8888\n    servicePort: 8888\n    hostPort: 8888\n    protocol: TCP\n  prometheus:\n    enabled: true\n    containerPort: 4319\n    servicePort: 4319\n    hostPort: 4319\n    protocol: TCP\nconfig:\n  receivers:\n    otlp:\n      protocols:\n        grpc:\n          endpoint: 0.0.0.0:4317\n        http:\n          cors:\n            allowed_origins:\n              - http://*\n              - https://*\n          endpoint: 0.0.0.0:4318\n  processors:\n    memory_limiter:\n      check_interval: 1s\n      limit_mib: 2000\n    k8sattributes/general:\n      auth_type: \"serviceAccount\"\n      passthrough: false\n      extract:\n        metadata:\n          - k8s.pod.name\n          - k8s.pod.uid\n          - k8s.namespace.name\n        labels:\n          - tag_name: dataplane_id\n            key: platform.tibco.com/dataplane-id\n            from: pod\n          - tag_name: workload_type\n            key: platform.tibco.com/workload-type\n            from: pod\n    batch: {}\n  exporters:\n    elasticsearch/log:\n      endpoints:\n      - ${env:ES_SERVER_SERVICE_ENDPOINT}\n      logs_index: ${env:ES_SERVICE_LOG_INDEX_NAME}\n      user: ${env:ES_SERVICE_LOG_INDEX_USERNAME}\n      password: ${env:ES_SERVICE_LOG_INDEX_PASSWORD}\n      retry:\n        enabled: false\n      tls:\n        insecure: false\n        insecure_skip_verify: true\n  extensions:\n    health_check: {}\n    memory_ballast:\n      size_in_percentage: 40\n  service:\n    telemetry:\n      logs: {}\n      metrics:\n        address: :8888\n    extensions:\n      - health_check\n      - memory_ballast\n    pipelines:\n      logs:\n        exporters:\n          - elasticsearch/log\n        processors:\n          - k8sattributes/general\n          - memory_limiter\n          - batch\n        receivers:\n          - otlp\n"}], "version": "0.69.7", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "otel-services"}, {"name": "jaeger", "flags": {"install": true, "isDevTesting": true, "createNamespace": false, "dependencyUpdate": true}, "values": [{"content": "provisionDataStore:\n  cassandra: false\n  elasticsearch: false\nstorage:\n  type: elasticsearch\n  elasticsearch:\n    tags-as-fields:\n      all: true\n    tls:\n      enabled: false\n      secretName: jaeger-elasticsearch\nagent:\n  enabled: false\nquery:\n  fullnameOverride: jaeger-query\n  basePath: /o11y/v1/traceproxy/${DATAPLANE-ID}\n  podLabels:\n    networking.platform.tibco.com/kubernetes-api: enable\n    egress.networking.platform.tibco.com/internet-all: enable\n  extraConfigmapMounts:\n    - name: jaeger-config\n      mountPath: /jaeger/config\n      subPath: \"\"\n      configMap: o11y-service\n      readOnly: true\n  serviceAccount:\n    create: false\n    name: ${SERVICE-ACCOUNT}\n  ingress:\n    enabled: false\n    ingressClassName: haproxy-dp-${DATAPLANE-ID}\n    annotations:\n      haproxy.org/cors-enable: \"true\"\n      haproxy.org/load-balance: leastconn\n      haproxy.org/src-ip-header: X-Real-IP\n      haproxy.org/timeout-http-request: 600s\n      ingress.kubernetes.io/rewrite-target: /\n      meta.helm.sh/release-name: jaeger\n    pathType: Prefix\n    hosts:\n      -\n  oAuthSidecar:\n    enabled: false\n  agentSidecar:\n    enabled: false\n  cmdlineParams:\n    es.version: 7\n    es.tls.enabled: true\n    es.tls.skip-host-verify: true\n    query.ui-config: /jaeger/config/jaeger-ui-config.json\ncollector:\n  fullnameOverride: jaeger-collector\n  podLabels:\n    networking.platform.tibco.com/kubernetes-api: enable\n    egress.networking.platform.tibco.com/internet-all: enable\n  serviceAccount:\n    create: false\n    name: ${SERVICE-ACCOUNT}\n  autoscaling:\n    enabled: false\n    minReplicas: 2\n    maxReplicas: 10\n    behavior:\n      targetCPUUtilizationPercentage: 80\n      targetMemoryUtilizationPercentage: 80\n  cmdlineParams:\n    es.version: 7\n    es.create-index-templates: \"false\"\n    es.tls.enabled: true\n    es.tls.skip-host-verify: true\n  service:\n    otlp:\n      grpc:\n        name: otlp-grpc\n        port: 4317\n      http:\n        name: otlp-http\n        port: 4318\n"}], "version": "0.71.24", "namespace": "${NAMESPACE}", "repository": {"chartMuseum": {"host": "${HELM_REPO}"}}, "releaseName": "jaeger"}], "deploymentStrategy": "weighted-concurrency"}, "services": [{"name": "o11y-service", "description": "o11y Service"}, {"name": "jaeger-collector", "description": "jaeger collector"}, {"name": "jaeger-query", "description": "jaeger query"}, {"name": "otel-userapp", "description": "otel userapp"}, {"name": "otel-finops", "description": "otel finops"}, {"name": "otel-services", "description": "otel services"}], "dependsOn": [], "provisioningRoles": ["DEV_OPS"], "allowMultipleInstances": false, "capabilityResourceDependencies": [{"type": "Observability", "required": true, "resourceId": "O11Y", "resourceType": "PLATFORM"}]}}'
WHERE CAPABILITY_ID = 'O11Y' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'PLATFORM';

-- Update EMS Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"allowMultipleInstances":true,"capabilityResourceDependencies":[{"required":false,"resourceId":"STORAGE","resourceType":"PLATFORM","type":"Message Storage","description":"Select a resource for the storage-class of EMS data store"},{"required":false,"resourceId":"STORAGE","resourceType":"PLATFORM","type":"Log Storage","description":"Select a resource for the storage-class of EMS logs store"}],"dependsOn":[],"provisioningRoles":["DEV_OPS"],"recipe":{"helmCharts":[{"name":"msg-ems-tp","flags":{"install":true,"createNamespace":false},"values":[{"content":"emsVersion: \"10.2.1-9\"\nems:\n    name: ${EMS_NAME}\n    use: ${EMS_USE}\n    sizing: ${EMS_SIZE}\n"}],"version":"1.0.27","namespace":"${NAMESPACE}","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"releaseName":"${EMS_NAME}"}]},"services":[{"description":"EMS Service","name":"ems"}]}}',
DISPLAY_NAME = 'TIBCO Enterprise Message Service™', DESCRIPTION = 'TIBCO Enterprise Message Service (EMS) allows you to send messages from your applications in a format that conforms to the Jakarta Messaging (JMS) specification. The software also extends the JMS specification with a reliable delivery mode and a no-acknowledge acknowledgement mode.'
WHERE CAPABILITY_ID = 'EMS' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'PLATFORM';

-- Update OAUTH2PROXY Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"recipe":{"helmCharts":[{"name":"oauth2-proxy","flags":{"install":true,"createNamespace":false,"dependencyUpdate":true},"values":[{"content":"global:     #global section can be removed once CP is having these values passed down through capability\n  cp:\n    cpHostName: \"${CP_HOST_NAME}\"\n    instanceId: \"${CP_CAPABILITY_INSTANCE_ID}\"\n    capability:\n      pathPrefix: \"${CAPABILITY_PATH_PREFIX}\"\n    resources:\n      ingress:\n        fqdn: \"${INGRESS_FQDN}\"\n        ingressClassName: \"${INGRESS_CLASSNAME}\"\n        secrets:\n          iat: \"${SECRETS_IAT}\"\nserviceAccount:\n  enabled: false\n  name: ${SERVICE_ACCOUNT_NAME}   #CP global var? \nimage:\n  repository: \"${IMAGE_REPOSITORY}/stratosphere/oauth2-proxy-tibx\"\n  tag: \"v7.4.0-tibx-prod-1\"\nconfig:\n  existingSecret: \"oauth2proxy-${CP_CAPABILITY_INSTANCE_ID}\" ### can be the release name to make it unique\nextraArgs:\n  oidc-issuer-url: \"https://${CP_HOST_NAME}\"\n  cookie-path: ${CAPABILITY_PATH_PREFIX}      ### ${global.cp.capability.pathPrefix}\n  proxy-prefix: ${CAPABILITY_PATH_PREFIX}/oauth2   ### ${global.cp.capability.pathPrefix}/oauth2\ningress:\n  className: ${INGRESS_CLASSNAME} ### ${global.cp.resources.ingress.ingressClassName}\n  hosts: \n    - ${INGRESS_FQDN} ### ${global.cp.resources.ingress.fqdn}\n  path: \"${CAPABILITY_PATH_PREFIX}/oauth2\" ### ${global.cp.capability.pathPrefix}/oauth2\nenableLogging: true\n"}],"version":"6.17.0-tibx-21","namespace":"${NAMESPACE}","repository":{"chartMuseum":{"host":"${HELM_REPO}"}}}]}}}'
WHERE CAPABILITY_ID = 'OAUTH2PROXY' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'INFRA_SIDECAR';

-- Update FLOGO Recipe
UPDATE V3_CAPABILITY_METADATA SET PACKAGE = '{"package":{"recipe":{"helmCharts":[{"name":"flogoprovisioner","namespace":"${NAMESPACE}","version":"1.0.22","repository":{"chartMuseum":{"host":"${HELM_REPO}"}},"values":[{"content":"global:\n  flogoprovisioner:\n    image:\n      tag: 182\nconfig:\n  APP_INIT_IMAGE_TAG: \"22\"\npublicApi:\n  ingress:\n    controllerName: ${INGRESS_CONTROLLER_NAME}\n    nginx:\n      className: ${INGRESS_CLASS_NAME}\n      pathPrefix: ${INGRESS_PATH_PREFIX}\n      fqdn: ${INGRESS_FQDN}\n"}],"flags":{"install":true,"createNamespace":false,"dependencyUpdate":true}}]},"services":[{"name":"flogoprovisioner","description":"Flogo Provisioner Service"},{"name":"oauth2-proxy","description":"OAuth2 Proxy"}],"dependsOn":[{"capabilityId":"INTEGRATIONCORE","version":[1,0,0],"capabilityType":"INFRA"},{"version":[1,0,0],"capabilityId":"OAUTH2PROXY","capabilityType":"INFRA_SIDECAR"}],"provisioningRoles":["DEV_OPS"],"capabilityResourceDependencies":[{"required":true,"resourceId":"INGRESS","resourceType":"PLATFORM","type":"Ingress Controller"}],"allowMultipleInstances":false}}'
WHERE CAPABILITY_ID = 'FLOGO' AND VERSION = '{1,0,0}' AND CAPABILITY_TYPE = 'PLATFORM';
