#
# Copyright Â© 2024-2025. Cloud Software Group, Inc.
# This file is subject to the license terms contained
# in the license file that is distributed with this file.
#

{{- if (include "cp-core-configuration.enableLogging" .) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "monitoring-service.consts.appName" . }}-fluentbit-config
  namespace: {{ include "monitoring-service.consts.namespace" . }}
  labels:
    {{- include "monitoring-service.shared.labels.standard" . | nindent 4 }}
data:
  fluent-bit.conf: |
    [SERVICE]
      Flush             1
      Log_Level         info
      Daemon            off
      Parsers_File      parsers.conf
      HTTP_Server       On
      HTTP_Listen       0.0.0.0
      HTTP_Port         2020
 
    @INCLUDE input.conf
    @INCLUDE filter.conf
    @INCLUDE output.conf
 
  input.conf: |
    [INPUT]
      Name              tail
      Tag               cp.${POD_NAMESPACE}.${POD_NAME}.${POD_ID}.${CONTAINER_NAME}
      Path              /var/log/pods/*.log
      DB                /var/log/db/flb_kube.db
      multiline.parser  docker, cri
      Mem_Buf_Limit     5MB
      Skip_Long_Lines   On
      Refresh_Interval  10
  
  filter.conf: |
    [FILTER]
      Name              record_modifier
      Match             cp.*
      Remove_key        stream
      Remove_key        _p
      Remove_key        date
    [FILTER]
      Name              parser
      Match             cp.*
      Key_Name          log
      Parser            x-log-level
      Reserve_Data      On
      Preserve_Key      On
    [FILTER]
      Name              parser
      Match             cp.*
      Key_Name          log
      Parser            x-app-id
      Reserve_Data      On
      Preserve_Key      On
    [FILTER]
      Name              parser
      Match             cp.*
      Key_Name          log
      Parser            x-user-id
      Reserve_Data      On
      Preserve_Key      On
    [FILTER]
      Name              parser
      Match             cp.*
      Key_Name          log
      Parser            tsc-go-logger
      Reserve_Data      On
      Preserve_Key      On
    [FILTER]
      Name              modify
      Match             cp.*
      Rename            log tscparseroriginal
    [FILTER]
      Name              nest
      Match             cp.*
      Operation         nest
      Wildcard          tscparser*
      Nest_under        log
      Remove_prefix     tscparser

  output.conf: |
    [OUTPUT]
      Name                 opentelemetry
      Match                cp.*
      Host                 otel-services.${POD_NAMESPACE}.svc.cluster.local
      Port                 4318
      logs_uri             /v1/logs
      log_response_payload True
      Tls                  Off
      Tls.verify           Off
  
  parsers.conf: |
    [PARSER]
      Name              x-log-level
      Format            regex
      Regex             ^*\[*x-log-level=(?:[\\" ]*)(?<tscparserxLogLevel>[^ "\\\]]*).*$
      Skip_Empty_Values False
    [PARSER]
      Name              x-app-id
      Format            regex
      Regex             ^*\[*x-app-id=(?:[\\" ]*)(?<tscparserxAppId>[^ "\\\]]*).*$
      Skip_Empty_Values False
    [PARSER]
      Name              x-user-id
      Format            regex
      Regex             ^*\[*x-user-id=(?:[\\" ]*)(?<tscparserxUserId>[^ "\\\]]*).*$
      Skip_Empty_Values False
    [PARSER]
      Name              webserver-x-user-id
      Format            regex
      Regex             ^*\[*x-user-id:(?:[\\" ]*)(?<tscparserxUserId>[^ "\\\]]*).*$
      Skip_Empty_Values False
    [PARSER]
      Name              tsc-go-logger
      Format            regex
      Regex             ^*\] (?<time>[\d]*-[\d]*-[\d]*T[\d]*:[\d]*:[\d]*.[\d]*Z) (?<tscparserlogger>[^ ]*) - (?<tscparsermessage>.*)$
      Skip_Empty_Values False
    [PARSER]
      Name              tag_parser
      Format            regex
      Regex (?<namespace_name>[^\.]+)\.(?<pod_name>[^\.]+)\.(?<pod_id>[^\.]+)\.(?<container_name>[^\.]+)

{{- end }}