#
# Copyright Â© 2023 - 2024. Cloud Software Group, Inc.
# This file is subject to the license terms contained
# in the license file that is distributed with this file.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tp-cp-hawk-console-recipes.appName" . }}-hawk-console-{{ include "tp-cp-hawk-console-recipes.resourceSuffix" . }}
  namespace: "{{ .Release.Namespace }}"
  labels:
    {{- include "tp-cp-hawk-console-recipes.labels" . | nindent 4 }}
data:
{{ (.Files.Glob "recipes/*").AsConfig | indent 2 }}
{{- if .Values.recipeOverride }}
  {{- if .Values.recipeOverride.HAWKCONSOLE }}
  recipeOverrides: |
    infra/hawkconsole/1.14.0/recipe.yaml:
      {{ toYaml .Values.recipeOverride.HAWKCONSOLE | nindent 6 }}
  {{- end }}
{{- end }}
---

# FIXME : See job cp-efs.job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "tp-cp-hawk-console-recipes.appName" . }}-hawk-console-{{ include "tp-cp-hawk-console-recipes.resourceSuffix" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "tp-cp-hawk-console-recipes.labels" . | nindent 4 }}
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        {{- include "tp-cp-hawk-console-recipes.labels" . | nindent 8 }}
    spec:
      {{- if .Values.global.podSecurityContext }}
      securityContext:
        {{- toYaml .Values.global.podSecurityContext | nindent 8 }}
      {{- end }}
      nodeSelector:
        kubernetes.io/os: linux
      containers:
      - name: tp-dp-hawk-console
        image: {{ include "tp-cp-hawk-console-recipes.image.registry" .}}{{"/"}}{{ include "tp-cp-hawk-console-recipes.image.repository" .}}{{"/"}}{{ .Values.image.hawkRecipeCreate.name }}:{{ .Values.image.hawkRecipeCreate.tag}}
        imagePullPolicy: {{ .Values.image.hawkRecipeCreate.pullPolicy }}
        {{- if .Values.global.containerSecurityContext.hawkinfrajobs }}
        securityContext:
          {{- toYaml .Values.global.containerSecurityContext.hawkinfrajobs | nindent 10 }}
        {{- end }}
        env:
        - name: TARGET_PATH
          value: "/private/tsc/config/capabilities"
        - name: JOB_WAIT_TARGET_PATH
          value: "180"
        volumeMounts:
        - mountPath: /boot
          name: recipes-vol
          readOnly: true
        - name: store-vol
          mountPath: /private/tsc/config
          subPath: tsc/config
        command: ['bash', '-c', ]
        args:
          - >
            bash < /boot/extract-recipe-packages.sh ; sleep 600 
      restartPolicy: Never
      volumes:
        - name: recipes-vol
          configMap:
            name: {{ include "tp-cp-hawk-console-recipes.appName" . }}-hawk-console-{{ include "tp-cp-hawk-console-recipes.resourceSuffix" . }}
        - name: store-vol
          persistentVolumeClaim:
            claimName: {{ include "tp-cp-hawk-console-recipes.pvc-name" . }}
      imagePullSecrets:
        {{- if (include "tp-cp-hawk-console-recipes.container-registry.secret" .) }}
        - name: {{ include "tp-cp-hawk-console-recipes.container-registry.secret" . }}
        {{- end}}
